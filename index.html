<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capability Assessment Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Add SortableJS library -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"></link>
    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase configuration, provided by the runtime environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Strategic guidance for each category
        const strategicGuidance = {
            'Compute': 'Adopting VCF for Compute offers increased automation for workload placement and dynamic resource allocation, leading to improved scalability and performance.',
            'Consumption & Services': 'Leveraging VCF for Consumption & Services streamlines the delivery of resources through integrated self-service portals and automated APIs, accelerating application deployment and lifecycle management.',
            'Data Protection & Recovery': 'VCF provides integrated data protection capabilities, simplifying disaster recovery and business continuity plans and improving resilience against data loss or corruption.',
            'Networks': 'Using VCF for Networks enables automated network provisioning, advanced security segmentation, and multi-site federation, leading to more resilient and agile network operations.',
            'Operations': 'VCF\'s integrated operations management provides a unified view for monitoring, analytics, and automation, simplifying fleet management and improving overall operational efficiency and cost control.',
            'Security Governance & Compliance': 'With VCF, security is integrated into the infrastructure, enabling automated policy enforcement, centralized identity management, and streamlined auditing and compliance.',
            'Storage': 'VCF-enabled storage offers policy-based management and flexible scaling, allowing for independent growth of compute and storage resources and simplifying data encryption and management.',
            'Operational Processes': 'VCF provides a framework for standardizing and automating operational processes, which can significantly reduce manual effort and improve overall efficiency.',
            'Organizational Roles': 'VCF helps align organizational roles by providing a unified platform for teams, fostering collaboration and ensuring clear ownership and accountability.',
            'Strategy': 'Adopting VCF can help a business-first IT strategy by providing the agility and scalability needed to quickly adapt to changing business priorities and goals.'
        };

        // YouTube video links for each capability area
        const youtubeLinks = {
            'Compute': {
                url: 'https://www.youtube.com/watch?v=EewYz6YUNUY&ab_channel=VMwareCloudFoundation',
                title: 'Exploring VMware Cloud Foundation: VCF Compute',
                channel: 'VMware Cloud Foundation',
                length: '14m 8s'
            },
            'Storage': {
                url: 'https://www.youtube.com/watch?v=vfIqmHc2-0g&ab_channel=VMwareCloudFoundation',
                title: 'VMware Cloud Foundation 5.0: A New Standard for Private Cloud',
                channel: 'VMware Cloud Foundation',
                length: '2m 29s'
            },
            'Networks': {
                url: 'https://www.youtube.com/watch?v=eHVX1zVOdAA&ab_channel=VMwareCloudFoundation',
                title: 'VMware Cloud Foundation - Deploy Application Virtual Networks (AVNs)',
                channel: 'VMware Cloud Foundation',
                length: '3m 51s'
            },
            'Operations': {
                url: 'https://www.youtube.com/watch?v=L7EepbHCARU&ab_channel=VMwareCloudFoundation',
                title: 'VMware Cloud Foundation Operations Overview',
                channel: 'VMware Cloud Foundation',
                length: '1m 48s'
            },
            'Consumption & Services': {
                url: 'https://www.youtube.com/watch?v=2JKcTuWuq2M&ab_channel=VMwareCloudFoundation',
                title: 'Self-Service Private Cloud with VMware Cloud Foundation',
                channel: 'VMware Cloud Foundation',
                length: '2m 5s'
            },
            'Security Governance & Compliance': {
                url: 'https://www.youtube.com/watch?v=tV30HfxHOEY&ab_channel=VMwareCloud',
                title: 'Platform Security within VMware Cloud Foundation',
                channel: 'VMware Cloud',
                length: '26m 0s'
            },
            'Data Protection & Recovery': {
                url: 'https://www.youtube.com/watch?v=dC1H0vevXT0&ab_channel=VMwareCloudFoundation',
                title: 'VMware Live Recovery',
                channel: 'VMware Cloud Foundation',
                length: '3m 1s'
            },
            'Operational Processes': {
                url: 'https://www.youtube.com/watch?v=cVop3DE-Na8&ab_channel=VMwareCloudFoundation',
                title: 'Boost Operational Efficiency with VMware Cloud Foundation',
                channel: 'VMware Cloud Foundation',
                length: '3m 22s'
            },
            'Organizational Roles': {
                url: 'https://www.youtube.com/watch?v=Y1DLurrtHaA&ab_channel=VMwareCloudFoundation',
                title: 'Exploring VMware Cloud Foundation: A Cloud Management Experience',
                channel: 'VMware Cloud Foundation',
                length: '14m 2s'
            },
            'Strategy': {
                url: 'https://www.youtube.com/watch?v=FvFE4thEmqU&ab_channel=VMwareCloudFoundation',
                title: 'Fastest Path to VMware Cloud Foundation',
                channel: 'VMware Cloud Foundation',
                length: '12m 40s'
            }
        };

        // Static panel content for each assessment type
        const panelContent = {
            'Infrastructure Capability Matrix (Feature Tracking)': {
                title: 'Infrastructure Assessment: The Strategic View',
                sections: [
                    { icon: 'fa-solid fa-lightbulb', heading: 'Why This Assessment Matters', content: ['Understand the importance of assessing capabilities.', 'Gain a clear perspective on your infrastructure\'s strengths and weaknesses.'], color: 'text-blue-500' },
                    { icon: 'fa-solid fa-money-check-dollar', heading: 'Impact on Metrics & Cost', content: ['See how gaps affect business efficiency, cost, and performance.', 'A mature infrastructure improves app deployment, security, and reduces operational costs.'], color: 'text-green-500' },
                    { icon: 'fa-solid fa-triangle-exclamation', heading: 'Key Challenges', content: ['Recognize common roadblocks organizations face.', 'Common issues include infrastructure silos, manual operations, and security gaps.'], color: 'text-red-500' },
                    { icon: 'fa-solid fa-rocket', heading: 'Strategic Advantage with VCF', content: ['Unlock agility, scalability, and cost optimization with VCF.', 'VCF provides a complete software-defined stack for simplified automation and consistent operations.'], color: 'text-purple-500' }
                ]
            },
            'Operations and Process Capability': {
                title: 'Operations Assessment: The Strategic View',
                sections: [
                    { icon: 'fa-solid fa-lightbulb', heading: 'Why This Assessment Matters', content: ['Understand the importance of assessing capabilities.', 'Evaluate your operational maturity to improve organizational effectiveness.'], color: 'text-blue-500' },
                    { icon: 'fa-solid fa-money-check-dollar', heading: 'Impact on Metrics & Cost', content: ['See how gaps affect business efficiency, cost, and performance.', 'Mature operations lead to greater efficiency and better resource utilization.'], color: 'text-green-500' },
                    { icon: 'fa-solid fa-triangle-exclamation', heading: 'Key Challenges', content: ['Recognize common roadblocks organizations face.', 'Many struggle with manual processes, unclear roles, and misaligned IT goals.'], color: 'text-red-500' },
                    { icon: 'fa-solid fa-gears', heading: 'Strategic Advantage with VCF', content: ['Unlock agility, scalability, and cost optimization with VCF.', 'VCF automates operational tasks and fosters a product-led approach.'], color: 'text-purple-500' }
                ]
            },
            'Cloud and App Strategy': {
                title: 'Cloud & App Strategy: The Strategic View',
                sections: [
                    { icon: 'fas fa-bullseye', heading: 'Understanding Your Priorities', content: ['Identify what drives your private and public cloud choices.', 'Pinpoint key events and workloads shaping your IT roadmap.'], color: 'text-blue-500' },
                    { icon: 'fas fa-cubes', heading: 'Gaining a Competitive Edge', content: ['Evaluate your containerization maturity.', 'See how a unified platform like VCF with Tanzu can streamline Kubernetes management.'], color: 'text-green-500' },
                    { icon: 'fas fa-exclamation-circle', heading: 'Translating Events into Action', content: ['Understand how mergers, cost cuts, or new app development can be addressed with an agile platform.', 'Learn how a flexible infrastructure can handle critical capacity changes.'], color: 'text-red-500' },
                    { icon: 'fas fa-shield-alt', heading: 'Protecting Critical Workloads', content: ['Recognize the importance of running regulated data in a secure, on-premises environment.', 'See how VCF is optimized for mission-critical and sensitive workloads.'], color: 'text-purple-500' }
                ]
            },
             'Priority Use Cases': {
                title: 'Strategic Importance of This Assessment',
                sections: [
                     { icon: 'fa-solid fa-lightbulb', heading: 'Strategic Importance', content: ["This assessment is more than a simple checklist; it's a strategic tool for identifying key priorities and aligning them with modern private cloud capabilities. By understanding your specific use cases, we can tailor a roadmap for success."], color: 'text-indigo-600' },
                     { icon: 'fa-solid fa-handshake', heading: 'Strengthening Partnerships', content: ["A clear, modern infrastructure strategy shows readiness to handle complex, mission-critical workloads, making you a more valuable partner."], color: 'text-green-600' },
                     { icon: 'fa-solid fa-chart-line', heading: 'Achieving Overall Success', content: ["Strategic adoption of a private cloud platform like VMware Cloud Foundation (VCF) enables agility, improved security, and operational efficiency, all of which are crucial for business growth."], color: 'text-blue-600' },
                     { icon: 'fa-solid fa-rocket', heading: 'Accelerating Innovation', content: ["The right platform reduces complexity, allowing your teams to focus on building new applications and driving innovation, rather than managing infrastructure."], color: 'text-purple-500' }
                ]
            }
        };

        // Data for all assessments
        const assessmentData = {
            'Infrastructure Capability Matrix (Feature Tracking)': {
                title: 'Infrastructure Capability Matrix (Feature Tracking)',
                isVCFApplicable: true,
                categories: {
                    'Compute': [
                        { statement: 'Fixed Compute Resources', phase: 'Developing', score: 1 },
                        { statement: 'High Availability', phase: 'Developing', score: 1 },
                        { statement: 'Automated Workload Load Balancing', phase: 'Developing', score: 1 },
                        { statement: 'Resource Prioritization', phase: 'Established', score: 2 },
                        { statement: 'Scalable Compute (Memory Tiering)', phase: 'Established', score: 2 },
                        { statement: 'Hardware Acceleration (GPU/DPU)', phase: 'Optimized', score: 3 }
                    ],
                    'Storage': [
                        { statement: 'Virtualized Storage (vSAN Snapshot Manager)', phase: 'Developing', score: 1 },
                        { statement: 'Policy Based Management', phase: 'Developing', score: 1 },
                        { statement: 'Deduplication & Compression', phase: 'Developing', score: 1 },
                        { statement: 'Fault Domains', phase: 'Developing', score: 1 },
                        { statement: 'Flexible Scaling (Independent Compute and Storage)', phase: 'Established', score: 2 },
                        { statement: 'Data at Rest Encryption', phase: 'Established', score: 2 },
                        { statement: 'File Services (vSAN File Services)', phase: 'Optimized', score: 3 },
                        { statement: 'Workload Encryption', phase: 'Optimized', score: 3 }
                    ],
                    'Networks': [
                        { statement: 'Virtualized Networks', phase: 'Developing', score: 1 },
                        { statement: 'Advanced Virtualized Networking', phase: 'Developing', score: 1 },
                        { statement: 'Shared Services Segmentation (vDefend)', phase: 'Developing', score: 1 },
                        { statement: 'Zone Segmentation (vDefend)', phase: 'Developing', score: 1 },
                        { statement: 'Load Balancing', phase: 'Developing', score: 1 },
                        { statement: 'Application Segmentation', phase: 'Established', score: 2 },
                        { statement: 'Tenant Segmentation', phase: 'Established', score: 2 },
                        { statement: 'Stateful Services', phase: 'Established', score: 2 },
                        { statement: 'Gateway Firewall', phase: 'Established', score: 2 },
                        { statement: 'Multi-Tenancy (VPC)', phase: 'Established', score: 2 },
                        { statement: 'Networking for Modern Applications (AVI WAF)', phase: 'Established', score: 2 },
                        { statement: 'Multi-Site/ Federation', phase: 'Optimized', score: 3 },
                        { statement: 'Global Policy Management', phase: 'Optimized', score: 3 }
                    ],
                    'Operations': [
                        { statement: 'Fleet Management (Certificate Management)', phase: 'Developing', score: 1 },
                        { statement: 'Visibility and Observability (LCM)', phase: 'Developing', score: 1 },
                        { statement: 'Analytics and Reporting (Diagnostics)', phase: 'Developing', score: 1 },
                        { statement: 'Performance Optimization', phase: 'Established', score: 2 },
                        { statement: 'Capacity Management', phase: 'Established', score: 2 },
                        { statement: 'Configuration Management', phase: 'Optimized', score: 3 },
                        { statement: 'Cost Efficiency', phase: 'Optimized', score: 3 }
                    ],
                    'Consumption & Services': [
                        { statement: 'IaaS (VKS with VM Service)', phase: 'Developing', score: 1 },
                        { statement: 'Self-Service Portal (Catalog Consumption)', phase: 'Developing', score: 1 },
                        { statement: 'API /CLI', phase: 'Established', score: 2 },
                        { statement: 'Infra-as-Code (LBaaS / FWaaS)', phase: 'Established', score: 2 },
                        { statement: 'PaaS / CaaS', phase: 'Optimized', score: 3 },
                        { statement: 'Data Services', phase: 'Optimized', score: 3 },
                        { statement: 'AI/ML Services (PAIF)', phase: 'Optimized', score: 3 },
                        { statement: 'XaaS', phase: 'Optimized', score: 3 },
                        { statement: 'CI/CD', phase: 'Optimized', score: 3 },
                        { statement: 'App Runtime Services', phase: 'Optimized', score: 3 }
                    ],
                    'Security Governance & Compliance': [
                        { statement: 'Identity and RBAC (VCF Single Sign-On)', phase: 'Developing', score: 1 },
                        { statement: 'Auditing and SIEM', phase: 'Developing', score: 1 },
                        { statement: 'Constraint Based Management', phase: 'Established', score: 2 },
                        { statement: 'Compliance Enforcement', phase: 'Established', score: 2 },
                        { statement: 'Data Governance', phase: 'Optimized', score: 3 }
                    ],
                    'Data Protection & Recovery': [
                        { statement: 'Data Protection (vSAN to vSAN Replication)', phase: 'Developing', score: 1 },
                        { statement: 'Disaster Avoidance (IDS/IPS)', phase: 'Developing', score: 1 },
                        { statement: 'Disaster Recovery', phase: 'Established', score: 2 },
                        { statement: 'Ransomware Recovery', phase: 'Optimized', score: 3 }
                    ]
                },
                categoryIcons: {
                    'Compute': 'fa-solid fa-microchip',
                    'Consumption & Services': 'fa-solid fa-cloud-arrow-up',
                    'Data Protection & Recovery': 'fa-solid fa-shield-virus',
                    'Networks': 'fa-solid fa-network-wired',
                    'Operations': 'fa-solid fa-gears',
                    'Security Governance & Compliance': 'fa-solid fa-lock',
                    'Storage': 'fa-solid fa-hard-drive'
                }
            },
            'Operations and Process Capability': {
                title: 'Operations and Process Capability',
                isVCFApplicable: true,
                categories: {
                    'Operational Processes': [
                        { statement: 'Basic ITSM Foundation: Core ITSM processes (e.g., Change Management, Incident Management, Problem Management, Event Management, Service Desk) are established and documented.', phase: 'Developing', score: 1 },
                        { statement: 'Standardized IT Services: Core IT Service Management (ITSM) and Service Portfolio processes are standardized with efficiency metrics.', phase: 'Established', score: 2 },
                        { statement: 'Standardized Control Processes: Operational and implementation control processes are in place and consistently standardized.', phase: 'Established', score: 2 },
                        { statement: 'Defined Process Tracking: Metrics are clearly defined and reported for all established processes.', phase: 'Established', score: 2 },
                        { statement: 'Automated Operations & Insights: Core processes are extensively automated for efficiency, providing real-time performance insights.', phase: 'Optimized', score: 3 },
                        { statement: 'Continuous Process Optimization: All processes are continuously improved by systematically addressing bottlenecks.', phase: 'Optimized', score: 3 },
                        { statement: 'Integrated Business Controls: IT processes are tightly integrated with business controls to achieve strategic objectives.', phase: 'Optimized', score: 3 }
                    ],
                    'Organizational Roles': [
                        { statement: 'Basic Ownership: Process and tool Owners are identified and in place.', phase: 'Developing', score: 1 },
                        { statement: 'Clear Roles & Accountability: Everyone has defined roles, responsibilities, and clear ownership for services, ensuring accountability and operational control.', phase: 'Established', score: 2 },
                        { statement: 'Collaborative Governance: Cross-functional teams work together, guided by formal governance boards with clear decision-making processes.', phase: 'Established', score: 2 },
                        { statement: 'Continuous Skill Development: Ongoing training programs ensure the workforce constantly updates its skills and knowledge.', phase: 'Established', score: 2 },
                        { statement: 'Product-Led Development: Teams are dedicated to building and managing technology as products.', phase: 'Optimized', score: 3 },
                        { statement: 'Strategic Innovation Engine: Our organization is structured to drive and manage technology innovation.', phase: 'Optimized', score: 3 },
                        { statement: 'Enterprise Knowledge Sharing: We centralize and distribute specialized expertise across the entire organization.', phase: 'Optimized', score: 3 }
                    ],
                    'Strategy': [
                        { statement: 'Basic Project Definition: Department project initiatives are identified and documented in a fundamental way.', phase: 'Developing', score: 1 },
                        { statement: 'Clear Project Success: All projects have clear definitions and measurable success criteria', phase: 'Established', score: 2 },
                        { statement: 'Aligned IT Goals: Every IT project directly supports documented IT goals.', phase: 'Established', score: 2 },
                        { statement: 'Shared Project Progress: Project success metrics are communicated across IT teams.', phase: 'Established', score: 2 },
                        { statement: 'Business-First IT: All IT work directly supports the company\'s top business goals.', phase: 'Optimized', score: 3 },
                        { statement: 'Automated Performance View: Project results are automatically shown to everyone, clearly.', phase: 'Optimized', score: 3 },
                        { statement: 'Adaptive Leadership Oversight: Leaders constantly adjust IT plans to match changing business priorities.', phase: 'Optimized', score: 3 }
                    ]
                },
                categoryIcons: {
                    'Operational Processes': 'fa-solid fa-diagram-project',
                    'Organizational Roles': 'fa-solid fa-users',
                    'Strategy': 'fa-solid fa-bullseye'
                }
            },
            'Cloud and App Strategy': {
                title: 'Cloud and App Strategy',
                isVCFApplicable: false,
                questions: {
                    'q1': {
                        title: '1. What is driving your cloud strategy?',
                        icon: 'fas fa-cogs',
                        type: 'checkbox',
                        options: [
                            'Business Transformation', 'Cloud ecosystem/Leverage unique cloud services', 'Cost savings',
                            'Speed/Agility', 'Better scalability', 'SLA', 'Governance & Compliance', 'Sovereignty',
                            'IT Mandate', 'Time'
                        ]
                    },
                    'q2': {
                        title: '2. Who are your key cloud providers?',
                        icon: 'fas fa-cloud',
                        type: 'checkbox',
                        options: [
                            'VMware by Broadcom', 'Amazon Web Services', 'Microsoft Azure', 'Google Cloud Platform',
                            'Oracle Cloud Service', 'Alibaba', 'IBM', 'Oracle Cloud', 'On-Premise Data Center',
                            'MSP/Third-Party Managed', 'Others'
                        ]
                    },
                    'q3': {
                        title: '3. What compelling events is your organization facing in the next 12 months?',
                        icon: 'fas fa-calendar-alt',
                        type: 'checkbox',
                        options: [
                            'Change in CxO', 'DC Evac / Lease Termination', 'Provider Change / Consolidation',
                            'Merger & Acquisition', 'Critical Capacity Increase', 'Critical Cost Reduction',
                            'Refresh datacenter/server', 'New App Development', 'App Modernization / Migration',
                            'Remote Workforce â€“ New or Expansion', 'Other'
                        ]
                    },
                    'q4': {
                        title: "4. What is the % distribution of your organization's applications across Mainframe, Private Cloud, and Public Cloud?",
                        icon: 'fas fa-chart-pie',
                        type: 'distribution',
                        categories: ['Mainframe', 'Private Cloud', 'Public Cloud'],
                        options: ['1-25%', '26-50%', '51-75%', '76-100%']
                    },
                    'q5': {
                        title: '5. What workloads are you currently running in your private cloud?',
                        icon: 'fas fa-database',
                        type: 'checkbox',
                        options: [
                            'Traditional Enterprise Applications (e.g., ERP, CRM, HR systems)',
                            'Databases (e.g., SQL, NoSQL, data warehouses)',
                            'AI/ML Workloads (e.g., training, inference, data processing)',
                            'High-Performance Computing (HPC) / Scientific Computing',
                            'Development & Test Environments', 'Data Analytics / Business Intelligence platforms',
                            'Highly Regulated/Sensitive Data Workloads (e.g., healthcare, financial data)',
                            'Custom Applications (internally developed)', 'Edge Computing workloads',
                            'Other (Please Specify)', 'Unsure/No specific workloads identified yet.'
                        ]
                    },
                    'q6': {
                        title: "6. What is your organization's CI/CD Pipeline Strategy?",
                        icon: 'fas fa-tasks',
                        type: 'checkbox',
                        options: [
                            'Version Control', 'Automated Testing', 'Build Optimization', 'Staged Deployments',
                            'Continuous Monitoring', 'Infrastructure as Code', 'Security Integration (DevSecOps)',
                            'Feedback Loops', 'Pipeline as Code'
                        ]
                    },
                    'q7': {
                        title: '7. What is your Vendor Container Strategy?',
                        icon: 'fas fa-box-open',
                        type: 'checkbox',
                        options: [
                            'Google Kubernetes Engine (GKE)', 'Amazon Elastic Kubernetes Service (EKS)',
                            'Azure Kubernetes Service (AKS)', 'Red Hat OpenShift Container Platform',
                            'VMware Tanzu', 'SUSE Rancher', 'Mirantis Kubernetes Engine (MKE)',
                            'Canonical Kubernetes (Ubuntu)', 'Platform9 Managed Kubernetes', 'Portainer'
                        ]
                    }
                }
            },
            'Priority Use Cases': {
                title: 'Priority Use Cases',
                isVCFApplicable: false,
                useCaseCategories: {
                    "Infrastructure Modernization": {
                        icon: "fa-solid fa-cloud-arrow-down",
                        useCases: [
                          { name: "Build and deploy private cloud infrastructure on-premises", icon: "fa-solid fa-building" },
                          { name: "Optimize infrastructure and operations", icon: "fa-solid fa-gauge-high" },
                          { name: "Extend data center to the edge, public and sovereign clouds", icon: "fa-solid fa-globe" }
                        ]
                    },
                    "Application Modernization": {
                        icon: "fa-solid fa-cubes",
                        useCases: [
                          { name: "Enable self-service infrastructure and cloud services for app teams", icon: "fa-solid fa-code" },
                          { name: "Build, run and manage Kubernetes and other modern apps", icon: "fa-solid fa-atom" },
                          { name: "Build, run and manage Private AI apps", icon: "fa-solid fa-brain" }
                        ]
                    },
                    "Security Modernization": {
                        icon: "fa-solid fa-shield-halved",
                        useCases: [
                          { name: "Strengthen compliance and harden infrastructure", icon: "fa-solid fa-certificate" },
                          { name: "Bolster lateral security and intrusion prevention / detection", icon: "fa-solid fa-fingerprint" },
                          { name: "Accelerate recovery from ransomware and other disasters", icon: "fa-solid fa-file-waveform" }
                        ]
                    }
                }
            }
        };


        let db, auth;
        let currentAssessment = null;
        let userId = null;
        let currentSurveyQuestionIndex = 0;
        let userChoices = {
            vcfStatus: {},
            optedOut: {},
            statements: {},
            surveyB: {},
            priorityUseCases: { // New structure for ranked priorities
                categoryOrder: [],
                itemOrder: {}
            }
        };
        let appState = 'landing';
        let currentLayoutView = 'structure'; // 'structure' or 'progression'

        const assessmentJourney = [
            'Cloud and App Strategy',
            'Infrastructure Capability Matrix (Feature Tracking)',
            'Operations and Process Capability',
            'Priority Use Cases'
        ];

        const dom = {
            mainContent: document.getElementById('main-content'),
            assessmentTitle: document.getElementById('assessment-title'),
            scoreDisplay: document.getElementById('score-display'),
            currentScoreDisplay: null,
            maxScoreDisplay: null,
            overallNormalizedScoreDisplay: null,
            overallStarsDisplay: null,
            userIdDisplay: document.getElementById('user-id-display'),
            goBackButton: document.getElementById('go-back-btn'),
            loadingScreen: document.getElementById('loading-screen'),
            guidancePanel: document.getElementById('guidance-panel'),
        };

        // Tailwind CSS custom configuration
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-in': 'slideIn 0.3s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-subtle': 'bounceSubtle 2s infinite',
                        'scale-in': 'scaleIn 0.2s ease-out',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        slideIn: {
                            '0%': { opacity: '0', transform: 'translateX(-20px)' },
                            '100%': { opacity: '1', transform: 'translateX(0)' }
                        },
                        bounceSubtle: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' }
                        },
                        scaleIn: {
                            '0%': { transform: 'scale(0.95)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        },
                        glow: {
                            '0%': { boxShadow: '0 0 5px rgba(59, 130, 246, 0.5)' },
                            '100%': { boxShadow: '0 0 20px rgba(59, 130, 246, 0.8)' }
                        }
                    }
                }
            }
        }

        // Initialize Firebase and Auth
        const initFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is empty. The application will run in a limited capacity without data persistence.");
                    return;
                }

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('Debug');
                console.log("Firebase initialized.");
            } catch (e) {
                console.error("Error during Firebase initialization or sign-in:", e);
                dom.loadingScreen.innerHTML = `<div class="text-center"><i class="fa-solid fa-exclamation-triangle text-red-500 text-6xl mb-4"></i><div class="text-xl text-red-500">Error loading application</div><div class="text-sm text-gray-500 mt-2">Check console for details</div></div>`;
            }
        };

        // Load user's previous data from Firestore
        const loadUserData = async () => {
            if (!userId || !db) {
                console.log("No user ID or database available to load data.");
                return;
            }
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'assessments', 'user_assessment');
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const loadedChoices = docSnap.data();
                    // Ensure all parts of the userChoices object are present
                    userChoices = {
                        vcfStatus: loadedChoices.vcfStatus || {},
                        optedOut: loadedChoices.optedOut || {},
                        statements: loadedChoices.statements || {},
                        surveyB: loadedChoices.surveyB || {},
                        priorityUseCases: loadedChoices.priorityUseCases || { categoryOrder: [], itemOrder: {} }
                    };
                    console.log("User data loaded successfully.");
                } else {
                    console.log("No user data found in Firestore, starting fresh.");
                }
            } catch (e) {
                console.error("Error loading user data from Firestore:", e);
            }
        };

        // Save user's data to Firestore
        const saveUserData = async () => {
            if (!userId || !db) {
                console.error("Cannot save data: User not authenticated or database not initialized.");
                return;
            }
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'assessments', 'user_assessment');
                await setDoc(docRef, userChoices);
                console.log("User data saved successfully.");
            } catch (e) {
                console.error("Error saving user data to Firestore:", e);
            }
        };

        // Renders the guidance panel content
        const renderGuidancePanel = (assessmentKey) => {
            const panelData = panelContent[assessmentKey];
            if (!panelData) {
                dom.guidancePanel.classList.add('hidden');
                return;
            }

            dom.guidancePanel.classList.remove('hidden');
            let panelHtml = `
                <div class="animate-fade-in">
                    <div class="text-center mb-6">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-600 mb-4 animate-pulse-slow">
                            <i class="fa-solid fa-lightbulb text-white text-2xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-800">${panelData.title}</h3>
                    </div>
                    ${panelData.sections.map((section, index) => `
                        <div class="mb-6 bg-white p-6 shadow-lg border border-gray-100 hover:shadow-xl transition-all duration-300 animate-slide-in" style="animation-delay: ${index * 0.1}s">
                            <div class="flex items-start space-x-4">
                                <div class="flex-shrink-0">
                                    <div class="w-12 h-12 bg-gradient-to-br from-gray-50 to-gray-100 flex items-center justify-center">
                                        <i class="${section.icon} text-xl ${section.color}"></i>
                                    </div>
                                </div>
                                <div class="flex-grow">
                                    <h4 class="text-lg font-semibold text-gray-800 mb-3">${section.heading}</h4>
                                    <ul class="text-gray-600 text-sm leading-relaxed space-y-2">
                                        ${section.content.map(point => `
                                            <li class="flex items-start space-x-2">
                                                <i class="fa-solid fa-check-circle ${section.color} mt-0.5 flex-shrink-0"></i>
                                                <span>${point}</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            dom.guidancePanel.innerHTML = panelHtml;
        };

        // Helper function to calculate normalized score and star rating
        const getNormalizedScoreAndStars = (currentScore, maxScore) => {
            if (maxScore === 0) {
                return { normalized: 0, stars: '<span class="text-gray-400">N/A</span>' };
            }
            const normalized = 1 + (4 * (currentScore / maxScore));
            const rating = Math.round(normalized * 2) / 2; // Round to nearest 0.5

            let starsHtml = '';
            for (let i = 1; i <= 5; i++) {
                if (rating >= i) {
                    starsHtml += '<i class="fa-solid fa-star"></i>'; // Full star
                } else if (rating === i - 0.5) {
                    starsHtml += '<i class="fa-solid fa-star-half-alt"></i>'; // Half star
                } else {
                    starsHtml += '<i class="fa-regular fa-star"></i>'; // Empty star
                }
            }

            return { normalized: normalized, stars: starsHtml };
        };
        
        // Main rendering function
        const renderApp = () => {
            dom.mainContent.innerHTML = '';
            dom.scoreDisplay.innerHTML = '';
            dom.scoreDisplay.classList.add('hidden');
            dom.assessmentTitle.textContent = '';
            dom.guidancePanel.classList.add('hidden');

            if (appState === 'landing') {
                dom.goBackButton.classList.add('hidden');
                renderLandingPage();
            } else {
                dom.goBackButton.classList.remove('hidden');
                if (appState === 'assessment') {
                    renderAssessment(currentAssessment);
                } else if (appState === 'survey') {
                    currentSurveyQuestionIndex = 0;
                    renderCloudStrategySurvey();
                } else if (appState === 'priority-use-cases') {
                    renderPriorityUseCases();
                } else if (appState === 'final-summary') {
                    renderFinalSummary();
                }
            }
            dom.loadingScreen.classList.add('hidden');
        };

        // Renders the initial assessment selection page
        const renderLandingPage = () => {
            dom.assessmentTitle.textContent = 'PCMO Cloud Maturity Model';
            dom.mainContent.innerHTML = `
                <div class="text-center mb-12 animate-fade-in">
                    <div class="inline-flex items-center justify-center w-24 h-24 bg-gradient-to-r from-blue-500 to-purple-600 mb-6 rounded-full shadow-lg animate-bounce-subtle">
                        <i class="fa-solid fa-route text-white text-4xl"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-800">Your Assessment Journey</h2>
                    <p class="text-xl text-gray-600 max-w-2xl mx-auto leading-relaxed mt-4">
                        Follow the path below to get a complete picture of your organization's capabilities, starting with your high-level strategy.
                    </p>
                </div>

                <div class="mt-8">
                    <div class="flex flex-col md:flex-row items-stretch justify-center gap-8 md:gap-4">
                        <!-- Step 1 Card -->
                        <div class="flex-1 group animate-fade-in" style="animation-delay: 0.1s">
                            <button id="start-journey-btn" class="journey-tile text-center w-full h-full p-8 bg-gradient-to-br from-indigo-500 to-purple-700 text-white rounded-lg shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:scale-105 flex flex-col items-center">
                                <i class="fa-solid fa-cloud-arrow-up text-4xl mb-4"></i>
                                <span class="text-sm font-bold opacity-80 mb-2 block">STEP 1</span>
                                <h3 class="text-2xl font-bold mb-2">Start Assessment Journey</h3>
                                <p class="opacity-90 flex-grow">Begin by defining your Cloud and App Strategy to set the foundation.</p>
                            </button>
                        </div>

                        <!-- Arrow Connector -->
                        <div class="flex-shrink-0 items-center justify-center hidden md:flex animate-fade-in" style="animation-delay: 0.2s">
                            <i class="fa-solid fa-arrow-right-long text-gray-400 text-4xl"></i>
                        </div>

                        <!-- Step 2 Card -->
                        <div class="flex-1 group animate-fade-in" style="animation-delay: 0.3s">
                            <button id="infra-btn" class="journey-tile text-center w-full h-full p-8 bg-white rounded-lg shadow-lg hover:shadow-xl hover:border-blue-500 border-2 border-transparent transition-all duration-300 transform hover:scale-105 flex flex-col items-center">
                                <i class="fa-solid fa-laptop-code text-4xl mb-4 text-gray-700"></i>
                                <span class="text-sm font-bold text-gray-500 mb-2 block">STEP 2</span>
                                <h3 class="text-2xl font-bold text-gray-800 mb-2">Infrastructure Capability Matrix</h3>
                                <p class="text-gray-600 flex-grow">Dive deep into the technical capabilities of your infrastructure.</p>
                            </button>
                        </div>

                        <!-- Arrow Connector -->
                        <div class="flex-shrink-0 items-center justify-center hidden md:flex animate-fade-in" style="animation-delay: 0.4s">
                            <i class="fa-solid fa-arrow-right-long text-gray-400 text-4xl"></i>
                        </div>

                        <!-- Step 3 Card -->
                        <div class="flex-1 group animate-fade-in" style="animation-delay: 0.5s">
                            <button id="ops-btn" class="journey-tile text-center w-full h-full p-8 bg-white rounded-lg shadow-lg hover:shadow-xl hover:border-blue-500 border-2 border-transparent transition-all duration-300 transform hover:scale-105 flex flex-col items-center">
                                <i class="fa-solid fa-diagram-project text-4xl mb-4 text-gray-700"></i>
                                <span class="text-sm font-bold text-gray-500 mb-2 block">STEP 3</span>
                                <h3 class="text-2xl font-bold text-gray-800 mb-2">Operations and Process Capability</h3>
                                <p class="text-gray-600 flex-grow">Evaluate the maturity of your operational processes and teams.</p>
                            </button>
                        </div>
                        
                        <!-- Arrow Connector -->
                        <div class="flex-shrink-0 items-center justify-center hidden md:flex animate-fade-in" style="animation-delay: 0.6s">
                            <i class="fa-solid fa-arrow-right-long text-gray-400 text-4xl"></i>
                        </div>

                        <!-- Step 4 Card -->
                         <div class="flex-1 group animate-fade-in" style="animation-delay: 0.7s">
                            <button id="use-cases-btn" class="journey-tile text-center w-full h-full p-8 bg-white rounded-lg shadow-lg hover:shadow-xl hover:border-blue-500 border-2 border-transparent transition-all duration-300 transform hover:scale-105 flex flex-col items-center">
                                <i class="fa-solid fa-list-check text-4xl mb-4 text-gray-700"></i>
                                <span class="text-sm font-bold text-gray-500 mb-2 block">STEP 4</span>
                                <h3 class="text-2xl font-bold text-gray-800 mb-2">Priority Use Cases</h3>
                                <p class="text-gray-600 flex-grow">Identify and prioritize key modernization use cases.</p>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('start-journey-btn').addEventListener('click', () => {
                currentAssessment = 'Cloud and App Strategy';
                appState = 'survey';
                renderApp();
            });
            document.getElementById('infra-btn').addEventListener('click', () => {
                currentAssessment = 'Infrastructure Capability Matrix (Feature Tracking)';
                appState = 'assessment';
                renderApp();
            });
            document.getElementById('ops-btn').addEventListener('click', () => {
                currentAssessment = 'Operations and Process Capability';
                appState = 'assessment';
                renderApp();
            });
             document.getElementById('use-cases-btn').addEventListener('click', () => {
                currentAssessment = 'Priority Use Cases';
                appState = 'priority-use-cases';
                renderApp();
            });
        };

        // Renders the score-based assessments with layout toggle
        const renderAssessment = (assessmentKey) => {
            const data = assessmentData[assessmentKey];
            dom.assessmentTitle.textContent = data.title;
            dom.scoreDisplay.classList.remove('hidden');
            renderGuidancePanel(assessmentKey);
            
            // Call calculateScore FIRST to get the values
            const { normalizedScoreText } = calculateScore();

            // --- Navigation Button Logic ---
            const currentJourneyIndex = assessmentJourney.indexOf(assessmentKey);
            let navButtonHtml = '';
            if (currentJourneyIndex < assessmentJourney.length - 1) {
                const nextAssessmentKey = assessmentJourney[currentJourneyIndex + 1];
                const nextAssessmentTitle = assessmentData[nextAssessmentKey].title.split(' ')[0];
                const nextAssessmentType = assessmentData[nextAssessmentKey].questions ? 'survey' : (assessmentData[nextAssessmentKey].useCaseCategories ? 'priority-use-cases' : 'assessment');
                navButtonHtml = `<button data-next-assessment="${nextAssessmentKey}" data-next-type="${nextAssessmentType}" class="next-step-btn group bg-blue-600 text-white px-6 py-3 font-medium rounded-md hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 hover:shadow-xl">Next Step: ${nextAssessmentTitle} <i class="fa-solid fa-arrow-right ml-2 group-hover:translate-x-1 transition-transform duration-300"></i></button>`;
            } else {
                navButtonHtml = `<button class="finish-journey-btn group bg-green-600 text-white px-6 py-3 font-medium rounded-md hover:bg-green-700 transition-all duration-300 transform hover:scale-105 hover:shadow-xl">Finish Journey <i class="fa-solid fa-flag-checkered ml-2"></i></button>`;
            }
            const navContainerHtml = `<div class="my-8 flex justify-end">${navButtonHtml}</div>`;

            dom.scoreDisplay.innerHTML = `<div class="bg-white/90 backdrop-blur-sm p-6 shadow-xl animate-fade-in"><div class="flex items-center justify-center"><div class="text-center"><div class="text-sm text-gray-500 mb-1">Overall Rating</div><span id="overall-normalized-score" class="font-bold text-3xl text-blue-600">${normalizedScoreText}</span></div></div></div>${navContainerHtml}`;
            
            let htmlContent = '';
            let categoryIndex = 0;
            
            for (const category in data.categories) {
                const statements = data.categories[category];
                const isIncluded = userChoices.optedOut[category] === undefined ? true : !userChoices.optedOut[category];
                const categoryId = category.replace(/\s/g, '-');
                const vcfEnabled = userChoices.vcfStatus[category] === undefined ? true : userChoices.vcfStatus[category];
                const showVCFToggle = data.isVCFApplicable;
                const categoryIcon = data.categoryIcons[category];
                
                let categoryCurrentScore = 0, maxCategoryScore = 0;
                statements.forEach(stmt => {
                    maxCategoryScore += stmt.score;
                    const statementKey = `${category}-${stmt.statement}`;
                    const status = userChoices.statements[statementKey] || 'not-implemented';
                    let statementScore = 0;
                    if (status === 'operational') statementScore = stmt.score;
                    else if (status === 'planned') statementScore = stmt.score * 0.7;
                    if (isIncluded) categoryCurrentScore += vcfEnabled ? statementScore : statementScore / 2;
                });

                const { normalized } = getNormalizedScoreAndStars(categoryCurrentScore, maxCategoryScore);
                const normalizedScoreText = maxCategoryScore > 0 ? `${normalized.toFixed(1)}/5` : 'N/A';
                
                const layoutToggleHtml = `<div class="flex justify-end mb-6"><div class="inline-flex rounded-md shadow-sm" role="group"><button type="button" data-view="structure" class="layout-toggle-btn px-4 py-2 text-sm font-medium ${currentLayoutView === 'structure' ? 'bg-indigo-600 text-white' : 'bg-white text-gray-900 hover:bg-gray-100'} rounded-l-lg border border-gray-200 focus:z-10 focus:ring-2 focus:ring-indigo-500"><i class="fa-solid fa-list mr-2"></i>Structure</button><button type="button" data-view="progression" class="layout-toggle-btn px-4 py-2 text-sm font-medium ${currentLayoutView === 'progression' ? 'bg-indigo-600 text-white' : 'bg-white text-gray-900 hover:bg-gray-100'} rounded-r-md border border-gray-200 focus:z-10 focus:ring-2 focus:ring-indigo-500"><i class="fa-solid fa-table-columns mr-2"></i>Progression</button></div></div>`;
                
                let statementsHtml;
                if (currentLayoutView === 'progression') {
                    const groupedByPhase = statements.reduce((acc, stmt) => { (acc[stmt.phase] = acc[stmt.phase] || []).push(stmt); return acc; }, {});
                    const phaseOrder = ['Developing', 'Established', 'Optimized'];
                    const phaseColors = { 'Developing': 'border-yellow-400 text-yellow-800 bg-yellow-50', 'Established': 'border-blue-400 text-blue-800 bg-blue-50', 'Optimized': 'border-green-400 text-green-800 bg-green-50' };
                    
                    statementsHtml = '<div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-x-6">';
                    phaseOrder.forEach(phase => {
                        const phaseStatements = groupedByPhase[phase] || [];
                        statementsHtml += `<div><h3 class="text-lg font-semibold mb-4 p-3 text-center ${phaseColors[phase] || 'border-gray-400 bg-gray-50'}">${phase}</h3>`;
                        if (phaseStatements.length > 0) {
                            phaseStatements.forEach(stmt => {
                                const statementKey = `${category}-${stmt.statement}`;
                                const currentStatus = userChoices.statements[statementKey] || 'not-implemented';
                                statementsHtml += `<div class="statement-card flex flex-col p-4 mb-4 bg-white shadow-sm border border-gray-200 hover:shadow-md hover:border-blue-300 transition-all duration-300 min-h-[160px] ${!isIncluded ? 'opacity-50 grayscale pointer-events-none' : ''}"><p class="text-gray-900 text-sm font-medium leading-relaxed flex-grow mb-4">${stmt.statement}</p><div class="flex-shrink-0 w-full mt-auto"><div class="segmented-control flex w-full rounded-md overflow-hidden border border-gray-300 shadow-sm"><button data-status="not-implemented" data-statement-key="${statementKey}" class="btn-status flex-1 px-1 py-2 text-xs font-medium transition-colors duration-200 ${currentStatus === 'not-implemented' ? 'bg-gray-700 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'}">Not Implemented</button><button data-status="planned" data-statement-key="${statementKey}" class="btn-status flex-1 px-1 py-2 text-xs font-medium transition-colors duration-200 ${currentStatus === 'planned' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'}">Planned</button><button data-status="operational" data-statement-key="${statementKey}" class="btn-status flex-1 px-1 py-2 text-xs font-medium transition-colors duration-200 ${currentStatus === 'operational' ? 'bg-green-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'}">Operational</button></div></div></div>`;
                            });
                        }
                        statementsHtml += '</div>';
                    });
                    statementsHtml += '</div>';
                } else {
                    statementsHtml = `<div class="space-y-4">${statements.map((stmt, index) => {
                        const statementKey = `${category}-${stmt.statement}`;
                        const currentStatus = userChoices.statements[statementKey] || 'not-implemented';
                        const phaseColors = { 'Developing': 'bg-yellow-100 text-yellow-800 border-yellow-200', 'Established': 'bg-blue-100 text-blue-800 border-blue-200', 'Optimized': 'bg-green-100 text-green-800 border-green-200' };
                        return `<div class="statement-card flex flex-col md:flex-row md:items-center justify-between p-4 bg-white shadow-sm border border-gray-200 hover:shadow-lg hover:border-blue-200 transition-all duration-300 ${!isIncluded ? 'opacity-50 grayscale pointer-events-none' : ''} animate-slide-in" style="animation-delay: ${index * 0.05}s"><div class="flex items-start space-x-4 flex-grow mb-4 md:mb-0 md:pr-4"><span class="flex-shrink-0 inline-flex items-center px-3 py-1 text-xs font-medium border ${phaseColors[stmt.phase] || 'bg-gray-100 text-gray-800 border-gray-200'}">${stmt.phase}</span><p class="text-gray-900 font-medium leading-relaxed">${stmt.statement}</p></div><div class="flex-shrink-0 w-full sm:w-auto"><div class="segmented-control flex w-full rounded-md overflow-hidden border border-gray-300 shadow-sm"><button data-status="not-implemented" data-statement-key="${statementKey}" class="btn-status flex-1 px-2 py-2 text-xs font-medium transition-colors duration-200 ${currentStatus === 'not-implemented' ? 'bg-gray-700 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'}">Not Implemented</button><button data-status="planned" data-statement-key="${statementKey}" class="btn-status flex-1 px-2 py-2 text-xs font-medium transition-colors duration-200 ${currentStatus === 'planned' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'}">Planned</button><button data-status="operational" data-statement-key="${statementKey}" class="btn-status flex-1 px-2 py-2 text-xs font-medium transition-colors duration-200 ${currentStatus === 'operational' ? 'bg-green-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'}">Operational</button></div></div></div>`;
                    }).join('')}</div>`;
                }

                htmlContent += `<div class="mb-12 animate-fade-in" style="animation-delay: ${categoryIndex * 0.1}s"><div class="flex items-center mb-6"><div class="flex-grow h-px bg-gradient-to-r from-transparent via-gray-300 to-transparent"></div><div class="px-4"><div class="w-3 h-3 bg-blue-500"></div></div><div class="flex-grow h-px bg-gradient-to-r from-transparent via-gray-300 to-transparent"></div></div><div class="bg-gradient-to-r from-white/90 to-gray-50/90 p-6 shadow-lg mb-6 border-l-4 border-indigo-500 hover:shadow-xl transition-all duration-300"><div class="flex flex-col lg:flex-row justify-between items-start lg:items-center space-y-4 lg:space-y-0"><div class="flex items-center space-x-4"><div class="w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg"><i class="${categoryIcon} text-2xl text-white"></i></div><div><h2 class="text-2xl font-bold text-gray-800">${category}</h2><div class="text-sm text-gray-500 mt-1">${statements.length} capabilities to assess</div></div></div><div class="flex items-center space-x-3 sm:space-x-6"><div class="text-center relative group"><div class="flex items-center space-x-2"><span class="font-bold text-xl text-blue-600">${normalizedScoreText}</span></div><button class="info-btn text-gray-400 hover:text-blue-600 transition-all duration-300 mt-1"><i class="fa-solid fa-info-circle"></i></button><div class="tooltip absolute top-full mt-2 right-0 w-72 p-4 bg-gray-900 text-white text-xs shadow-2xl hidden group-hover:block z-10"><div class="tooltip-arrow absolute -top-2 left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-8 border-r-8 border-b-8 border-gray-900"></div><p class="mb-2">This is the normalized 5-star rating for the <strong>${category}</strong> category.</p><p class="mb-2 font-mono text-xs bg-gray-800 p-1 rounded">1 + (4 * (Your Score / Max))</p><p><strong>Example:</strong> If your score is 5 and the max is 10, your rating is 3.0/5 stars.</p></div></div><div class="flex items-center space-x-3"><label class="flex items-center space-x-2 cursor-pointer group"><span class="text-sm text-gray-600 group-hover:text-gray-800 transition-colors">Opted</span><div class="relative"><input type="checkbox" id="include-${categoryId}" data-category="${category}" class="sr-only include-checkbox" ${isIncluded ? 'checked' : ''}><div class="block w-11 h-6 transition-all duration-300 ${isIncluded ? 'bg-green-500 shadow-lg' : 'bg-gray-300'}"></div><div class="dot absolute left-1 top-1 bg-white w-4 h-4 transition-all duration-300 transform ${isIncluded ? 'translate-x-5 shadow-lg' : 'shadow-sm'}"></div></div></label>${showVCFToggle ? `<label class="flex items-center space-x-3 cursor-pointer group"><span class="text-sm text-gray-600 group-hover:text-gray-800 transition-colors font-medium">Using VCF</span><div class="relative"><input type="checkbox" id="vcf-toggle-${categoryId}" data-category="${category}" class="sr-only vcf-toggle-checkbox" ${vcfEnabled ? 'checked' : ''}><div class="block w-12 h-7 transition-all duration-300 ${vcfEnabled ? 'bg-gradient-to-r from-green-400 to-green-600 shadow-lg animate-glow' : 'bg-gray-400'}"></div><div class="dot absolute left-1 top-1 bg-white w-5 h-5 transition-all duration-300 transform shadow-md ${vcfEnabled ? 'translate-x-5' : ''}"></div></div></label>` : ''}</div></div></div></div>${layoutToggleHtml}<div class="mb-6 ${vcfEnabled ? 'hidden' : ''} bg-gradient-to-r from-yellow-50 to-orange-50 border-l-4 border-yellow-400 text-yellow-800 p-6 shadow-md animate-slide-in" role="alert"><div class="flex items-start space-x-3"><i class="fa-solid fa-exclamation-triangle text-yellow-600 text-xl mt-1"></i><div><p class="font-bold mb-2">Strategic Disadvantage Detected</p><p class="text-sm leading-relaxed">${strategicGuidance[category]}</p></div></div></div>${statementsHtml}</div>`;
                categoryIndex++;
            }
            
            htmlContent += navContainerHtml;
            dom.mainContent.innerHTML = htmlContent;

            dom.mainContent.querySelectorAll('.btn-status').forEach(b => b.addEventListener('click', e => { userChoices.statements[e.currentTarget.dataset.statementKey] = e.currentTarget.dataset.status; saveUserData(); renderAssessment(currentAssessment); }));
            dom.mainContent.querySelectorAll('.vcf-toggle-checkbox, .include-checkbox').forEach(c => c.addEventListener('change', e => { const cat = e.target.dataset.category; if (e.target.classList.contains('vcf-toggle-checkbox')) userChoices.vcfStatus[cat] = e.target.checked; else userChoices.optedOut[cat] = !e.target.checked; saveUserData(); renderAssessment(currentAssessment); }));
            dom.mainContent.querySelectorAll('.layout-toggle-btn').forEach(b => b.addEventListener('click', e => { currentLayoutView = e.currentTarget.dataset.view; renderAssessment(currentAssessment); }));
            document.querySelectorAll('.next-step-btn').forEach(b => b.addEventListener('click', e => { currentAssessment = e.currentTarget.dataset.nextAssessment; appState = e.currentTarget.dataset.nextType; renderApp(); }));
            document.querySelectorAll('.finish-journey-btn').forEach(b => b.addEventListener('click', () => { appState = 'landing'; renderApp(); }));
        };

        // Renders the new survey wizard for Cloud and App Strategy
        const renderCloudStrategySurvey = () => {
            const data = assessmentData[currentAssessment];
            const questionKeys = Object.keys(data.questions);
            const totalQuestions = questionKeys.length;
            const currentQuestionKey = questionKeys[currentSurveyQuestionIndex];
            const question = data.questions[currentQuestionKey];

            dom.assessmentTitle.textContent = data.title;
            renderGuidancePanel(currentAssessment);

            const progressPercentage = ((currentSurveyQuestionIndex + 1) / totalQuestions) * 100;
            
            let questionHtml = '';
            if (question.type === 'checkbox') {
                 questionHtml = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${question.options.map((option, index) => {
                        const optionId = `${currentQuestionKey}_option${index}`;
                        const isChecked = userChoices.surveyB[currentQuestionKey] && userChoices.surveyB[currentQuestionKey].includes(option);
                        return `
                            <label for="${optionId}" class="flex items-start p-3 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors duration-200">
                                <input type="checkbox" id="${optionId}" name="${currentQuestionKey}" value="${option}" class="w-5 h-5 mt-1 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500" ${isChecked ? 'checked' : ''}>
                                <span class="ml-3 text-gray-700">${option}</span>
                            </label>
                        `;
                    }).join('')}
                </div>`;
            } else if (question.type === 'distribution') {
                questionHtml = `<div class="space-y-6">
                    ${question.categories.map(cat => `
                        <div class="p-4 border rounded-lg">
                            <p class="font-semibold text-gray-800 mb-3">${cat}</p>
                            <div class="flex flex-wrap gap-4">
                                ${question.options.map((opt, index) => {
                                    const radioId = `${currentQuestionKey}_${cat.replace(/\s+/g, '')}_${index}`;
                                    const isChecked = userChoices.surveyB[currentQuestionKey] && userChoices.surveyB[currentQuestionKey][cat] === opt;
                                    return `
                                        <label for="${radioId}" class="flex items-center space-x-2 cursor-pointer">
                                            <input type="radio" id="${radioId}" name="${currentQuestionKey}_${cat.replace(/\s+/g, '')}" value="${opt}" class="text-blue-600 focus:ring-blue-500" ${isChecked ? 'checked' : ''}>
                                            <span class="text-gray-700">${opt}</span>
                                        </label>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>`;
            }


            let htmlContent = `
                <div class="mb-4">
                    <p class="text-center text-sm font-medium text-gray-600 mb-2">Question ${currentSurveyQuestionIndex + 1} of ${totalQuestions}</p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="bg-blue-600 h-2.5 rounded-full transition-all duration-500 ease-out" style="width: ${progressPercentage}%"></div>
                    </div>
                </div>

                <div class="survey-content mt-8 p-6 bg-white shadow-lg border border-gray-100 animate-fade-in">
                    <div class="question-section" data-question-name="${currentQuestionKey}">
                        <div class="question-title flex items-center text-xl font-semibold text-gray-800 mb-6">
                            <i class="${question.icon} text-indigo-500 mr-4 text-2xl w-8 text-center"></i>
                            <span>${question.title}</span>
                        </div>
                        ${questionHtml}
                    </div>
                </div>

                <div class="survey-navigation mt-6 flex justify-between items-center">
                    <button id="survey-back-btn" class="bg-gray-200 text-gray-700 px-6 py-3 font-medium rounded-md hover:bg-gray-300 transition-all duration-300 ${currentSurveyQuestionIndex === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentSurveyQuestionIndex === 0 ? 'disabled' : ''}>
                        <i class="fa-solid fa-arrow-left mr-2"></i> Back
                    </button>
                    <button id="survey-next-btn" class="bg-blue-600 text-white px-6 py-3 font-medium rounded-md hover:bg-blue-700 transition-all duration-300">
                        ${currentSurveyQuestionIndex === totalQuestions - 1 ? 'Next Step <i class="fa-solid fa-arrow-right ml-2"></i>' : 'Next <i class="fa-solid fa-arrow-right ml-2"></i>'}
                    </button>
                </div>
            `;
            dom.mainContent.innerHTML = htmlContent;

            dom.mainContent.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(input => {
                input.addEventListener('change', (e) => {
                    const qName = questionKeys[currentSurveyQuestionIndex];
                    const questionType = assessmentData[currentAssessment].questions[qName].type;
                    if (questionType === 'checkbox') {
                        if (!userChoices.surveyB[qName]) userChoices.surveyB[qName] = [];
                        if (e.target.checked) userChoices.surveyB[qName].push(e.target.value);
                        else userChoices.surveyB[qName] = userChoices.surveyB[qName].filter(val => val !== e.target.value);
                    } else if (questionType === 'distribution') {
                         if (!userChoices.surveyB[qName]) userChoices.surveyB[qName] = {};
                         userChoices.surveyB[qName][e.target.name.split('_')[1]] = e.target.value;
                    }
                    saveUserData();
                });
            });

            document.getElementById('survey-back-btn').addEventListener('click', () => { if (currentSurveyQuestionIndex > 0) { currentSurveyQuestionIndex--; renderCloudStrategySurvey(); } });
            document.getElementById('survey-next-btn').addEventListener('click', () => { if (currentSurveyQuestionIndex < totalQuestions - 1) { currentSurveyQuestionIndex++; renderCloudStrategySurvey(); } else { currentAssessment = assessmentJourney[1]; appState = 'assessment'; renderApp(); } });
        };

        // Renders the interactive Priority Use Cases section
        const renderPriorityUseCases = () => {
            const data = assessmentData[currentAssessment];
            dom.assessmentTitle.textContent = data.title;
            renderGuidancePanel(currentAssessment);

            // Initialize priority data if it doesn't exist
            if (!userChoices.priorityUseCases || !userChoices.priorityUseCases.categoryOrder || userChoices.priorityUseCases.categoryOrder.length === 0) {
                const defaultCategories = Object.keys(data.useCaseCategories);
                userChoices.priorityUseCases.categoryOrder = defaultCategories;
                userChoices.priorityUseCases.itemOrder = {};
                defaultCategories.forEach(catName => {
                    userChoices.priorityUseCases.itemOrder[catName] = data.useCaseCategories[catName].useCases.map(uc => uc.name);
                });
            }

            let categoryHtml = '';
            userChoices.priorityUseCases.categoryOrder.forEach(categoryName => {
                const categoryData = data.useCaseCategories[categoryName];
                const itemOrder = userChoices.priorityUseCases.itemOrder[categoryName] || [];
                
                let itemsHtml = '';
                itemOrder.forEach(useCaseName => {
                    const useCase = categoryData.useCases.find(uc => uc.name === useCaseName);
                    if (useCase) {
                        itemsHtml += `
                            <div class="use-case-item flex items-center p-3 bg-white border rounded-md shadow-sm" data-id="${useCase.name}">
                                <i class="fa-solid fa-grip-vertical item-drag-handle cursor-grab text-gray-400 mr-4"></i>
                                <i class="${useCase.icon} mr-3 text-gray-600"></i>
                                <span class="text-sm font-medium text-gray-800">${useCase.name}</span>
                            </div>
                        `;
                    }
                });

                categoryHtml += `
                    <div class="category-container bg-gray-50 p-4 rounded-lg border border-gray-200" data-id="${categoryName}">
                        <div class="flex items-center mb-4 pb-2 border-b">
                           <i class="fa-solid fa-grip-vertical category-drag-handle cursor-grab text-gray-500 mr-3"></i>
                           <i class="${categoryData.icon} mr-3 text-indigo-600 text-xl"></i>
                           <h3 class="text-xl font-semibold text-gray-800">${categoryName}</h3>
                        </div>
                        <div class="use-case-list space-y-3" data-category-name="${categoryName}">${itemsHtml}</div>
                    </div>
                `;
            });

            dom.mainContent.innerHTML = `
                <div class="animate-fade-in">
                    <p class="text-center text-gray-600 mb-8 max-w-2xl mx-auto">Drag and drop both the categories and the items within them to rank your modernization priorities.</p>
                    <div id="category-list" class="space-y-6">${categoryHtml}</div>
                    <div class="flex justify-center mt-8">
                        <button id="view-summary-btn" class="w-full sm:w-auto px-8 py-3 bg-indigo-600 text-white font-bold rounded-md shadow-lg hover:bg-indigo-700 transition-colors duration-300">
                            View Final Summary
                        </button>
                    </div>
                </div>
            `;

            // Initialize Sortable for categories
            const categoryList = document.getElementById('category-list');
            new Sortable(categoryList, {
                animation: 150,
                handle: '.category-drag-handle',
                ghostClass: 'sortable-ghost',
                onEnd: (evt) => {
                    const newOrder = Array.from(evt.to.children).map(el => el.dataset.id);
                    userChoices.priorityUseCases.categoryOrder = newOrder;
                    saveUserData();
                }
            });

            // Initialize Sortable for each use case list
            document.querySelectorAll('.use-case-list').forEach(list => {
                new Sortable(list, {
                    animation: 150,
                    handle: '.item-drag-handle',
                    ghostClass: 'sortable-ghost',
                    onEnd: (evt) => {
                        const categoryName = evt.to.dataset.categoryName;
                        const newOrder = Array.from(evt.to.children).map(el => el.dataset.id);
                        userChoices.priorityUseCases.itemOrder[categoryName] = newOrder;
                        saveUserData();
                    }
                });
            });

            document.getElementById('view-summary-btn').addEventListener('click', () => {
                appState = 'final-summary';
                renderApp();
            });
        };


        /**
         * Formats a long string into an array of shorter strings for radar chart labels.
         * @param {string} label The string to format.
         * @param {number} maxLength The maximum length of each line.
         * @returns {string|string[]} The formatted label.
         */
        const formatRadarLabel = (label, maxLength = 15) => {
            const words = label.split(' ');
            if (words.length < 2) {
                return label;
            }
            
            let lines = [];
            let currentLine = words[0];

            for (let i = 1; i < words.length; i++) {
                const word = words[i];
                if (currentLine.length + word.length + 1 <= maxLength) {
                    currentLine += ' ' + word;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            }
            lines.push(currentLine);
            return lines;
        };

        const renderFinalSummary = () => {
            dom.assessmentTitle.textContent = "PCMO Cloud Maturity Model Assessment Summary";
            dom.guidancePanel.classList.add('hidden');

            let infraCurrentScore = 0;
            let infraMaxScore = 0;
            let opsCurrentScore = 0;
            let opsMaxScore = 0;

            // Calculate Infrastructure Score
            const infraData = assessmentData['Infrastructure Capability Matrix (Feature Tracking)'];
            for (const category in infraData.categories) {
                if (userChoices.optedOut[category]) continue;
                infraData.categories[category].forEach(stmt => {
                    infraMaxScore += stmt.score;
                    const status = userChoices.statements[`${category}-${stmt.statement}`] || 'not-implemented';
                    let score = 0;
                    if (status === 'operational') score = stmt.score;
                    else if (status === 'planned') score = stmt.score * 0.7;
                    infraCurrentScore += (userChoices.vcfStatus[category] !== false) ? score : score / 2;
                });
            }

            // Calculate Operations Score
            const opsData = assessmentData['Operations and Process Capability'];
            for (const category in opsData.categories) {
                if (userChoices.optedOut[category]) continue;
                opsData.categories[category].forEach(stmt => {
                    opsMaxScore += stmt.score;
                    const status = userChoices.statements[`${category}-${stmt.statement}`] || 'not-implemented';
                    let score = 0;
                    if (status === 'operational') score = stmt.score;
                    else if (status === 'planned') score = stmt.score * 0.7;
                    opsCurrentScore += (userChoices.vcfStatus[category] !== false) ? score : score / 2;
                });
            }
            
            const totalCurrentScore = infraCurrentScore + opsCurrentScore;
            const totalMaxPossibleScore = infraMaxScore + opsMaxScore;
            
            const { normalized } = getNormalizedScoreAndStars(totalCurrentScore, totalMaxPossibleScore);
            const normalizedScoreText = totalMaxPossibleScore > 0 ? `${normalized.toFixed(1)}/5` : 'N/A';

            // Breakdown scores
            const { normalized: infraNormalized } = getNormalizedScoreAndStars(infraCurrentScore, infraMaxScore);
            const infraNormalizedScoreText = infraMaxScore > 0 ? `${infraNormalized.toFixed(1)}/5` : 'N/A';

            const { normalized: opsNormalized } = getNormalizedScoreAndStars(opsCurrentScore, opsMaxScore);
            const opsNormalizedScoreText = opsMaxScore > 0 ? `${opsNormalized.toFixed(1)}/5` : 'N/A';
            
            // --- START: Chart Data Calculation ---
            // --- Infrastructure Chart Calculation ---
            const infraChartLabels = [];
            const infraChartData = [];
            for (const category in infraData.categories) {
                if (userChoices.optedOut[category]) { continue; }
                infraChartLabels.push(formatRadarLabel(category));
                let categoryCurrentScore = 0;
                let categoryMaxScore = 0;
                infraData.categories[category].forEach(stmt => {
                    categoryMaxScore += stmt.score;
                    const status = userChoices.statements[`${category}-${stmt.statement}`] || 'not-implemented';
                    let score = 0;
                    if (status === 'operational') score = stmt.score;
                    else if (status === 'planned') score = stmt.score * 0.7;
                    categoryCurrentScore += (userChoices.vcfStatus[category] !== false) ? score : score / 2;
                });
                const { normalized: catNormalized } = getNormalizedScoreAndStars(categoryCurrentScore, categoryMaxScore);
                infraChartData.push(catNormalized);
            }

            // --- Operations Chart Calculation ---
            const opsChartLabels = [];
            const opsChartData = [];
            for (const category in opsData.categories) {
                if (userChoices.optedOut[category]) { continue; }
                opsChartLabels.push(formatRadarLabel(category));
                let categoryCurrentScore = 0;
                let categoryMaxScore = 0;
                opsData.categories[category].forEach(stmt => {
                    categoryMaxScore += stmt.score;
                    const status = userChoices.statements[`${category}-${stmt.statement}`] || 'not-implemented';
                    let score = 0;
                    if (status === 'operational') score = stmt.score;
                    else if (status === 'planned') score = stmt.score * 0.7;
                    categoryCurrentScore += (userChoices.vcfStatus[category] !== false) ? score : score / 2;
                });
                const { normalized: catNormalized } = getNormalizedScoreAndStars(categoryCurrentScore, categoryMaxScore);
                opsChartData.push(catNormalized);
            }
            // --- END: Chart Data Calculation ---
            
            let useCasesSummaryListHtml = '<ol class="list-decimal list-inside space-y-2 text-gray-700">';
            const priorities = userChoices.priorityUseCases;
            if (priorities.categoryOrder && priorities.categoryOrder.length > 0) {
                 priorities.categoryOrder.forEach(catName => {
                     useCasesSummaryListHtml += `<li class="mt-4"><strong class="text-lg font-semibold text-gray-800">${catName}</strong>`;
                     const itemOrder = priorities.itemOrder[catName] || [];
                     if (itemOrder.length > 0) {
                         useCasesSummaryListHtml += '<ol class="list-alpha list-inside ml-6 mt-2 space-y-1">';
                         itemOrder.forEach(itemName => {
                             useCasesSummaryListHtml += `<li>${itemName}</li>`;
                         });
                         useCasesSummaryListHtml += '</ol>';
                     }
                      useCasesSummaryListHtml += `</li>`;
                 });
            } else {
                 useCasesSummaryListHtml = '<p class="text-center text-gray-500">No use cases were prioritized.</p>';
            }
             useCasesSummaryListHtml += '</ol>';

            const insightsHtml = generateFinalInsights({ infraCurrentScore, infraMaxScore, opsCurrentScore, opsMaxScore, choices: userChoices });

            const infoIcon = (tooltipText) => `
                <span class="relative group inline-block ml-2">
                    <i class="fa-solid fa-info-circle text-gray-400 hover:text-blue-600 cursor-pointer"></i>
                    <div class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 w-64 p-2 bg-gray-800 text-white text-xs rounded-md shadow-lg hidden group-hover:block z-10">
                        ${tooltipText}
                        <div class="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-x-4 border-x-transparent border-t-4 border-t-gray-800"></div>
                    </div>
                </span>
            `;

            const summaryHtml = `
            <div class="animate-fade-in space-y-12">
                <div>
                     <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Overall Maturity Rating</h2>
                    <div class="bg-white/90 backdrop-blur-sm p-6 shadow-xl rounded-lg">
                        <div class="flex items-center justify-center">
                            <div class="text-center relative group">
                                <div class="text-sm text-gray-500 mb-1">Overall Rating</div>
                                <div class="flex items-center space-x-2">
                                    <span class="font-bold text-3xl text-blue-600">${normalizedScoreText}</span>
                                    ${infoIcon('This is the combined, normalized score from both the Infrastructure and Operations assessments. Formula: 1 + (4 * (Your Score / Max Score)).')}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-4 rounded-lg text-center border shadow-md hover:shadow-lg transition-shadow">
                            <h3 class="text-md font-semibold text-gray-700 mb-2 flex items-center justify-center">
                                Infrastructure Capability
                                ${infoIcon('This is the aggregated score from the detailed Infrastructure Capability Matrix assessment.')}
                            </h3>
                            <span class="font-bold text-2xl text-indigo-600">${infraNormalizedScoreText}</span>
                        </div>
                        <div class="bg-white p-4 rounded-lg text-center border shadow-md hover:shadow-lg transition-shadow">
                            <h3 class="text-md font-semibold text-gray-700 mb-2 flex items-center justify-center">
                                Operations Capability
                                ${infoIcon('This is the aggregated score from the detailed Operations and Process Capability assessment.')}
                            </h3>
                            <span class="font-bold text-2xl text-indigo-600">${opsNormalizedScoreText}</span>
                        </div>
                    </div>
                </div>

                <!-- START: Charts Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-lg shadow-lg border">
                        <h3 class="text-xl font-bold text-center text-gray-800 mb-4 flex items-center justify-center">
                            Infrastructure Capability Breakdown
                            ${infoIcon('This chart shows the maturity score (1-5) for each component. The inner blue line is your current score, and the outer gray line is the benchmark.')}
                        </h3>
                        <canvas id="infraRadarChart"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-lg border">
                        <h3 class="text-xl font-bold text-center text-gray-800 mb-4 flex items-center justify-center">
                            Operations Capability Breakdown
                            ${infoIcon('This chart shows the maturity score (1-5) for each component. The inner green line is your current score, and the outer gray line is the benchmark.')}
                        </h3>
                        <canvas id="opsRadarChart"></canvas>
                    </div>
                </div>
                <!-- END: Charts Section -->

                <!-- START: Call to Action Notification -->
                <div class="text-center p-4 mt-8 bg-blue-50 border border-blue-200 rounded-lg shadow-sm animate-fade-in">
                    <p class="text-sm text-blue-800">
                        These charts highlight your maturity gaps. A consolidated set of calls to action, along with supporting video materials, is available below.
                    </p>
                    <i class="fa-solid fa-angles-down mt-2 text-blue-500 animate-bounce"></i>
                </div>
                <!-- END: Call to Action Notification -->
                
                <div>
                     <h2 class="text-3xl font-bold text-center text-gray-800 mb-6 flex items-center justify-center">
                        Your Ranked Priorities
                        ${infoIcon('This section reflects the priorities you set in the "Priority Use Cases" drag-and-drop assessment.')}
                     </h2>
                     <div class="text-left mx-auto max-w-2xl mb-6 p-6 bg-white shadow-md rounded-lg border">${useCasesSummaryListHtml}</div>
                </div>

                <div>
                    <h2 class="text-3xl font-bold text-center text-gray-800 mb-6 flex items-center justify-center">
                        Insights & Recommendations
                        ${infoIcon('This section provides dynamically generated advice, actionable steps, and video resources based on your assessment results.')}
                    </h2>
                    <div class="summary-text p-6 bg-gray-50 rounded-lg border space-y-4">${insightsHtml}</div>
                </div>

                <div class="mt-12 text-center"><button class="finish-journey-btn group bg-green-600 text-white px-8 py-4 font-bold rounded-md hover:bg-green-700 transition-all duration-300 transform hover:scale-105 hover:shadow-xl text-lg">Finish Journey & Return Home <i class="fa-solid fa-flag-checkered ml-2"></i></button></div>
            </div>`;
            dom.mainContent.innerHTML = summaryHtml;

            // --- START: Chart Rendering ---
            const radarChartOptions = {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    r: {
                        angleLines: { color: 'rgba(0, 0, 0, 0.1)' },
                        grid: { color: 'rgba(0, 0, 0, 0.1)' },
                        min: 0,
                        max: 5,
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1,
                            backdropColor: 'rgba(255, 255, 255, 0.75)',
                            color: '#4b5563'
                        },
                        pointLabels: {
                            font: { size: 12 },
                            color: '#1f2937',
                            padding: 5
                        }
                    }
                },
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: context => `${context.dataset.label || ''}: ${context.parsed.r.toFixed(1)}`
                        }
                    }
                }
            };

            const infraCtx = document.getElementById('infraRadarChart');
            if (infraCtx) {
                new Chart(infraCtx, {
                    type: 'radar',
                    data: {
                        labels: infraChartLabels,
                        datasets: [{
                            label: 'Current Maturity',
                            data: infraChartData,
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                        }, {
                            label: 'Benchmark',
                            data: infraChartLabels.map(() => 5),
                            backgroundColor: 'rgba(209, 213, 219, 0.2)',
                            borderColor: 'rgba(107, 114, 128, 1)',
                            borderWidth: 1,
                            pointBackgroundColor: 'rgba(107, 114, 128, 1)',
                        }]
                    },
                    options: radarChartOptions
                });
            }

            const opsCtx = document.getElementById('opsRadarChart');
            if (opsCtx) {
                new Chart(opsCtx, {
                    type: 'radar',
                    data: {
                        labels: opsChartLabels,
                        datasets: [{
                            label: 'Current Maturity',
                            data: opsChartData,
                            backgroundColor: 'rgba(22, 163, 74, 0.2)',
                            borderColor: 'rgba(22, 163, 74, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(22, 163, 74, 1)',
                        }, {
                            label: 'Benchmark',
                            data: opsChartLabels.map(() => 5),
                            backgroundColor: 'rgba(209, 213, 219, 0.2)',
                            borderColor: 'rgba(107, 114, 128, 1)',
                            borderWidth: 1,
                            pointBackgroundColor: 'rgba(107, 114, 128, 1)',
                        }]
                    },
                    options: { ...radarChartOptions, scales: { r: { ...radarChartOptions.scales.r, pointLabels: { ...radarChartOptions.scales.r.pointLabels, font: { size: 14 } } } } }
                });
            }
            // --- END: Chart Rendering ---
            
            dom.mainContent.querySelector('.finish-journey-btn').addEventListener('click', () => { appState = 'landing'; renderApp(); });
        };

        // Calculates the score
        const calculateScore = () => {
            if (!currentAssessment || !assessmentData[currentAssessment].isVCFApplicable) {
                return { normalizedScoreText: 'N/A' };
            }
            
            const data = assessmentData[currentAssessment];
            let totalCurrentScore = 0, totalMaxPossibleScore = 0;
            for (const category in data.categories) {
                if (userChoices.optedOut[category]) continue;
                data.categories[category].forEach(stmt => {
                    totalMaxPossibleScore += stmt.score;
                    const status = userChoices.statements[`${category}-${stmt.statement}`] || 'not-implemented';
                    let score = 0;
                    if (status === 'operational') score = stmt.score;
                    else if (status === 'planned') score = stmt.score * 0.7;
                    totalCurrentScore += (userChoices.vcfStatus[category] !== false) ? score : score / 2;
                });
            }
            
            const { normalized } = getNormalizedScoreAndStars(totalCurrentScore, totalMaxPossibleScore);
            const normalizedScoreText = totalMaxPossibleScore > 0 ? `${normalized.toFixed(1)}/5` : 'N/A';
            return { normalizedScoreText };
        };
        
        // Generates dynamic insights for the final summary page
        function generateFinalInsights(data) {
            const { infraCurrentScore, infraMaxScore, opsCurrentScore, opsMaxScore, choices } = data;

            let finalHtml = '';

            const generateInsightFor = (title, assessmentKey, currentScore, maxScore) => {
                let insightHtml = `<div class="p-4 rounded-lg border bg-white shadow-sm mb-6">`;
                insightHtml += `<h4 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">${title}</h4>`;

                const { normalized } = getNormalizedScoreAndStars(currentScore, maxScore);
                
                if (normalized.toFixed(1) >= 4.9) { // Close enough to 5/5
                    insightHtml += `<div class="p-4 rounded-md flex items-start space-x-4 bg-green-50 border-green-200 border-l-4"><i class="fa-solid fa-crown text-xl text-green-600 mt-1"></i><div><h4 class="font-bold text-green-800">Excellent Maturity!</h4><p class="text-gray-700 text-sm">You have demonstrated a high level of maturity in this area. Your focus should be on maintaining this standard and exploring advanced capabilities like Private AI and multi-cloud federation to stay ahead.</p></div></div>`;
                } else {
                    const assessmentConfig = assessmentData[assessmentKey];
                    const gaps = [];
                    for (const category in assessmentConfig.categories) {
                        if (choices.optedOut[category]) continue;
                        assessmentConfig.categories[category].forEach(stmt => {
                            const status = choices.statements[`${category}-${stmt.statement}`] || 'not-implemented';
                            if (status !== 'operational') {
                                gaps.push({ ...stmt, category });
                            }
                        });
                    }
                    
                    const groupedGaps = gaps.reduce((acc, gap) => {
                        if (!acc[gap.category]) acc[gap.category] = [];
                        acc[gap.category].push(gap.statement.split(':')[0]);
                        return acc;
                    }, {});

                    const relevantCategories = Object.keys(groupedGaps);

                    insightHtml += `
                        <div class="mb-4">
                            <h5 class="font-semibold text-gray-700 mb-2"><i class="fa-solid fa-stairs mr-2 text-blue-500"></i>Your Path to a 5/5 Score</h5>
                            <p class="text-sm text-gray-600 mb-3">To achieve the highest level of maturity, focus on implementing capabilities in these key areas:</p>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                                ${relevantCategories.map(category => `
                                    <div class="p-3 bg-gray-50 border border-gray-200 rounded-lg">
                                        <h6 class="font-bold text-gray-800">${category}</h6>
                                        <ul class="list-disc list-inside text-sm text-gray-700 mt-1 space-y-1">
                                            ${groupedGaps[category].map(statement => `<li>${statement}</li>`).join('')}
                                        </ul>
                                    </div>
                                `).join('')}
                            </div>
                        </div>`;

                    insightHtml += `
                        <div class="mb-4">
                            <h5 class="font-semibold text-gray-700 mb-2"><i class="fa-solid fa-rocket mr-2 text-purple-500"></i>How VCF Accelerates Your Journey</h5>
                            <p class="text-sm text-gray-600 mb-3">VMware Cloud Foundation provides an integrated platform to address these gaps directly:</p>
                            <ul class="text-sm text-gray-700 space-y-2">
                            ${relevantCategories.map(cat => {
                                const video = youtubeLinks[cat];
                                return `
                                    <li class="p-3 bg-purple-50 rounded-md">
                                        <div>
                                            <strong class="text-purple-800">${cat}:</strong> ${strategicGuidance[cat]}
                                        </div>
                                        ${video ? `
                                        <a href="${video.url}" target="_blank" rel="noopener noreferrer" class="flex items-start mt-3 p-3 bg-white rounded-md border hover:bg-gray-50 transition-colors duration-200 group">
                                            <i class="fa-brands fa-youtube text-red-500 text-3xl mr-3 mt-1"></i>
                                            <div class="flex-grow">
                                                <p class="font-bold text-sm text-blue-700 group-hover:underline">${video.title}</p>
                                                <p class="text-xs text-gray-500">${video.channel}</p>
                                            </div>
                                            <div class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full whitespace-nowrap">${video.length}</div>
                                        </a>` : ''}
                                    </li>
                                `}).join('')}
                            </ul>
                        </div>`;

                    insightHtml += `
                        <div>
                            <h5 class="font-semibold text-gray-700 mb-2"><i class="fa-solid fa-bullseye mr-2 text-green-500"></i>Strategic Advantages</h5>
                            <p class="text-sm text-gray-600">By leveraging VCF to close these gaps, you will unlock significant advantages, including enhanced operational efficiency, strengthened security, and increased business agility, allowing IT to be a true innovation driver.</p>
                        </div>`;
                }
                insightHtml += `</div>`;
                return insightHtml;
            };

            finalHtml += generateInsightFor('Infrastructure Capability Insights', 'Infrastructure Capability Matrix (Feature Tracking)', infraCurrentScore, infraMaxScore);
            finalHtml += generateInsightFor('Operations and Process Capability Insights', 'Operations and Process Capability', opsCurrentScore, opsMaxScore);

            if ((choices.surveyB['q2'] || []).length > 2) {
                finalHtml += `<div class="p-4 rounded-md flex items-start space-x-4 bg-yellow-50 border-yellow-200 border-l-4 mt-6"><i class="fa-solid fa-triangle-exclamation text-xl text-yellow-600 mt-1"></i><div><h4 class="font-bold text-yellow-800">General Insight: Multi-Cloud Complexity</h4><p class="text-gray-700 text-sm">Managing multiple cloud providers and on-premise infrastructure can lead to inconsistent operations and security gaps. A unified platform like VCF can mitigate these challenges.</p></div></div>`;
            }

            return finalHtml;
        }

        // Main app initialization
        window.onload = async () => {
            dom.loadingScreen.classList.remove('hidden');
            await initFirebase();
            if (auth) {
                onAuthStateChanged(auth, async (user) => {
                    if (user) { userId = user.uid; } 
                    else {
                        try {
                            const cred = initialAuthToken ? await signInWithCustomToken(auth, initialAuthToken) : await signInAnonymously(auth);
                            userId = cred.user.uid;
                        } catch (e) { console.error("Sign-in error:", e); }
                    }
                    dom.userIdDisplay.textContent = `User ID: ${userId}`;
                    await loadUserData();
                    renderApp();
                });
            } else { renderApp(); }
            dom.goBackButton.addEventListener('click', () => {
                const currentIndex = assessmentJourney.indexOf(currentAssessment);
                if (currentIndex > 0) {
                    currentAssessment = assessmentJourney[currentIndex - 1];
                    const prevData = assessmentData[currentAssessment];
                    appState = prevData.questions ? 'survey' : (prevData.useCaseCategories ? 'priority-use-cases' : 'assessment');
                } else { appState = 'landing'; }
                renderApp();
            });
        };
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; color: #374151; }
        .container-grid { max-width: 1400px; display: grid; grid-template-columns: 1fr; gap: 2rem; }
        @media (min-width: 1024px) { .container-grid { grid-template-columns: 2fr 1fr; } }
        .dot { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .segmented-control > button { border-right: 1px solid #d1d5db; }
        .segmented-control > button:last-child { border-right: none; }
        .sortable-ghost { opacity: 0.5; background: #c8ebfb; }
        .category-drag-handle, .item-drag-handle { cursor: grab; }
        .category-drag-handle:active, .item-drag-handle:active { cursor: grabbing; }
        ol.list-alpha { list-style-type: lower-alpha; }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div id="loading-screen" class="fixed inset-0 bg-white flex items-center justify-center z-50 transition-opacity duration-500">
        <div class="text-center animate-fade-in">
            <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-r from-blue-500 to-purple-600 mb-6 animate-spin">
                <i class="fa-solid fa-cog text-white text-3xl"></i>
            </div>
            <div class="text-xl text-gray-700 font-semibold">Loading Assessment Tool...</div>
            <div class="text-sm text-gray-500 mt-2">Preparing your capability evaluation</div>
        </div>
    </div>
    
    <div class="container-grid mx-auto">
        <div class="bg-white/95 backdrop-blur-sm p-6 md:p-10 shadow-2xl border border-white/20">
            <div class="flex justify-between items-center mb-8">
                <button id="go-back-btn" class="group bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 px-6 py-3 font-medium hover:from-gray-200 hover:to-gray-300 transition-all duration-300 transform hover:scale-105 hover:shadow-xl">
                    <i class="fa-solid fa-arrow-left mr-2 group-hover:-translate-x-1 transition-transform duration-300"></i>
                    Go Back
                </button>
                <div class="text-sm text-gray-500 bg-gray-50 px-4 py-2" id="user-id-display"></div>
            </div>

            <h1 id="assessment-title" class="text-4xl sm:text-5xl font-extrabold text-center mb-12 bg-clip-text text-transparent bg-gradient-to-r from-gray-700 to-gray-900"></h1>

            <div id="score-display" class="hidden"></div>
            <div id="main-content"></div>
        </div>
        
        <div id="guidance-panel" class="bg-white/95 backdrop-blur-sm p-6 md:p-10 shadow-2xl border border-white/20 md:sticky md:top-8 self-start"></div>
    </div>
</body>
</html>

